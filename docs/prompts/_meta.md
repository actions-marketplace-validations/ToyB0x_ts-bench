# TypeScriptプロジェクト最適化のためのメタプロンプト

## 本プロンプトの目的

TypeScriptプロジェクトにおける性能最適化手法を体系化し、AIを活用して効率的に実装可能なプロンプトとして構造化することで、開発生産性とコンパイル性能の向上を支援する。

## 背景

TypeScript開発における性能課題は開発体験に直接影響する：

### 主要な課題領域
- **IDE体験**: 型推論やインテリセンスの応答速度
- **ビルド性能**: TypeScriptコンパイル時間とメモリ使用量
- **開発効率**: Hot Reloadや型チェックの速度
- **CI/CD**: パイプラインでのビルド時間とリソース消費

これらは相互に関連し、`tsc`の実行性能が全体の開発体験を左右する。

## AI支援による継続的改善

### メタプロンプト自体の進化
- **AI共同進化**: DevinやClaude、ClineなどのAIは本メタプロンプトの改善機会を積極的に提案すること
- **技術追従**: TypeScript、ビルドツール、開発環境の最新動向を反映
- **実証ベース**: 実際の性能改善結果に基づく手法の評価更新

### 品質保証
- **検証可能性**: 各手法は`ts-bench`などのツールで測定可能であること
- **再現性**: AIが自動実装する際の具体的な手順を明示
- **安全性**: 本番環境への影響リスクを明確化

## 技術リソースと参考資料

### TypeScript公式ドキュメント
- **Performance Wiki**: https://github.com/microsoft/TypeScript/wiki/Performance  
  コンパイル性能の基本原則とベストプラクティス（interfaces優先、型注釈追加等）
- **Performance Tracing**: https://github.com/microsoft/TypeScript/wiki/Performance-Tracing  
  `--generateTrace`を用いた詳細な性能分析手法（TypeScript 4.1+の高精度トレース機能）
- **VS Code Language Service**: https://github.com/microsoft/TypeScript/wiki/Debugging-Language-Service-in-VS-Code  
  IDE統合における性能問題の診断（TSServer デバッグとパフォーマンス最適化）
- **Issue #30235**: https://github.com/microsoft/TypeScript/issues/30235  
  大規模プロジェクトにおける性能課題の議論（マルチスレッド コンパイルの必要性と制約）

### モノレポ・ビルドツール
- **Turborepo Compiled Packages**: https://turborepo.com/docs/core-concepts/internal-packages#compiled-packages  
  モノレポでの効率的なTypeScriptビルド戦略（Just-in-Time vs Compiled vs Publishable パッケージ）
- **TypeScript Project References**: https://turborepo.com/docs/guides/tools/typescript#you-likely-dont-need-typescript-project-references  
  Turborepo の Project References 非推奨指針（設定複雑化とキャッシュ層の問題）
- **Turborepo Discussions**: TypeScript パフォーマンスとキャッシュ戦略の実践的議論
  - https://github.com/vercel/turborepo/discussions/10325 （TypeScript 設定の最適化とIDE統合）
  - https://github.com/vercel/turborepo/discussions/4143 （重複型チェック問題と並列処理の課題）

### 測定・分析ツール
- **ts-bench**: https://github.com/ToyB0x/ts-bench (このリポジトリ)  
  TypeScript性能の継続的測定とベンチマーク
- **DeepWiki**: https://deepwiki.com/ToyB0x/ts-bench  
  プロジェクトの詳細な技術ドキュメント
- **@typescript/analyze-trace**: https://www.npmjs.com/package/@typescript/analyze-trace  
  TypeScriptトレースファイルの自動解析

### 実践的な改善事例
- **大規模プロジェクト最適化**: https://zenn.dev/forcia_tech/articles/20231017_tsuji  
  Zodスキーマ事前コンパイルによる14秒→8秒改善など、実際のプロダクションでの性能改善事例
- **型展開防止**: https://qiita.com/knjname/items/fc83a4248f459f1b052e  
  複雑な再帰型による6分→数秒の劇的なコンパイル速度向上テクニック
- **明示的型注釈**: https://zenn.dev/cybozu_frontend/articles/ts-explicit-type-annotation  
  isolatedDeclarationsと組み合わせた型推論負荷軽減の具体的手法

## AI実装戦略と最適化手法

### 実装方針

1. **段階的アプローチ**: 低リスクな設定変更から開始
   - ⭐⭐⭐⭐⭐ 実装容易度の手法を優先実装  
   - 設定ファイル変更 → コード構造改善 → 大規模リファクタリングの順序

2. **測定駆動開発**: 各変更前後での客観的性能測定を必須とする
   - `ts-bench`による継続的ベンチマーク実施
   - `tsc --generateTrace`と`@typescript/analyze-trace`による詳細分析
   - 改善効果の定量化と手法評価の継続的更新

3. **AI自動化優先**: 人間判断を最小化した実装戦略
   - ⭐⭐⭐⭐ 以上のAI自動化評価手法を体系的に活用
   - コードレビューとリスク評価の自動化
   - 段階的ロールバック機能の実装

4. **安全性重視**: 本番環境への影響リスクを最小化
   - デグレリスク⭐⭐以下の手法から段階的実装
   - フィーチャーフラグによる安全な展開
   - 継続的インテグレーションでの性能回帰検知

### 評価基準
各手法を以下の5段階基準で評価し、AIによる自動実装の優先順位を決定する：

**凡例**:
- **実装容易度**: ⭐⭐⭐⭐⭐（設定1-2行変更）⭐⭐⭐⭐（数分の基本設定）⭐⭐⭐（数時間の変更）⭐⭐（数日の複雑変更）⭐（数週間のリファクタリング）
- **段階実装**: ⭐⭐⭐⭐⭐（ファイル単位）⭐⭐⭐⭐（モジュール単位）⭐⭐⭐（パッケージ単位）⭐⭐（制約ありの部分実装）⭐（全体一括のみ）
- **AI自動化**: ⭐⭐⭐⭐⭐（完全自動）⭐⭐⭐⭐（ほぼ自動）⭐⭐⭐（半自動）⭐⭐（限定サポート）⭐（人間判断必須）
- **性能影響**: ⭐⭐⭐⭐⭐（50%以上改善）⭐⭐⭐⭐（20-50%改善）⭐⭐⭐（10-20%改善）⭐⭐（5-10%改善）⭐（5%未満改善）
- **デグレリスク**: ⭐（ほぼなし）⭐⭐（低い）⭐⭐⭐（中程度）⭐⭐⭐⭐（高い）⭐⭐⭐⭐⭐（非常に高い）

### TypeScript最適化手法一覧


### 1. 設定最適化
| 手法 | 実装容易度 | 段階実装 | AI自動化 | 性能影響 | デグレリスク | 説明 |
|------|------------|----------|----------|----------|-------------|------|
| tsconfig.json調整 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | 基本的なコンパイラ設定の最適化。target、module、moduleResolution等の適切な設定により、不要な型チェックや変換処理を削減 |
| isolatedDeclarations | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | TypeScript 5.5+の新機能。明示的型注釈を強制してモジュール間型依存を除去し、並列処理と宣言ファイル生成を高速化 |
| isolatedModules | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ | 各ファイルを独立したモジュールとして処理。他ファイルへの依存を排除し、並列型チェックとツールチェーン統合を最適化 |
| 型定義絞り込み | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐ | 使用しない@typesパッケージの除外、必要な型定義のみの selective import により型チェック対象を最小化 |
| コンパイラオプション最適化 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | strict系設定、skipLibCheck、incremental等の適切な組み合わせで型チェック負荷を調整 |
| excludeパターン最適化 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐ | node_modules、dist、test等の不要ディレクトリを効率的に除外し、型チェック対象ファイルを削減 |
| baseUrl/paths最適化 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐ | モジュール解決の効率化。baseUrlとpathsによる短縮エイリアスで型解決パスを最適化し、コンパイル速度を向上 |
| extendedDiagnostics活用 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ | ⭐ | tsc --extendedDiagnosticsによる詳細な性能診断。ボトルネック特定のための基本的なコンパイル時間とメモリ使用量分析 |

### 2. コード構造最適化
| 手法 | 実装容易度 | 段階実装 | AI自動化 | 性能影響 | デグレリスク | 説明 |
|------|------------|----------|----------|----------|-------------|------|
| 明示的型注釈 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐ | 関数戻り値、変数、パラメータに明示的な型注釈を追加。型推論処理を削減し、isolatedDeclarationsと組合せで劇的なコンパイル時間とIDE応答性を向上 |
| 型展開防止 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ | 複雑な再帰型による指数的型計算を防止。typeofや明示的型名で型推論を制限し、6分→数秒のコンパイル改善事例あり（劇的なパフォーマンス向上） |
| const assertions最適化 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐ | `as const`による型推論の最適化。リテラル型の固定化により型計算を削減し、オブジェクトや配列の型推論コストを軽減 |
| Interface vs Union最適化 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | TypeScript公式推奨：interfaceの型関係キャッシュ活用。unionタイプよりもinterfaceを優先して型チェック効率を向上 |
| 型エイリアス最適化 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐ | 複雑な型定義を名前付きエイリアスで簡素化。匿名型の計算負荷を削減し、型キャッシュ機能を有効活用 |
| 生成コード事前コンパイル | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ | ⭐ | Zodスキーマ等の自動生成TypeScriptファイルを事前に.js/.d.tsに変換。14秒→8秒の改善事例（43%改善）、型推論負荷を大幅削減 |
| Conditional Types削減 | ⭐ | ⭐ | ⭐ | ⭐⭐⭐ | ⭐⭐ | 高度な条件付き型や映射型の使用を最小限に抑制。型レベル計算の複雑さを削減して処理時間を短縮 |

### 3. プロジェクト構造最適化
| 手法 | 実装容易度 | 段階実装 | AI自動化 | 性能影響 | デグレリスク | 説明 |
|------|------------|----------|----------|----------|-------------|------|
| Project References | ⭐ | ⭐ | ⭐ | ⭐⭐ | ⭐⭐⭐ | 大規模プロジェクトで複数のtsconfig.jsonを連携。理論的には増分ビルド効果があるが、実際の改善は限定的。Turborepoでは非推奨（設定複雑化とキャッシュ問題） |
| モノレポ最適化 | ⭐ | ⭐ | ⭐ | ⭐⭐⭐ | ⭐⭐⭐ | Turborepo/Nxによるタスク並列化とキャッシュ戦略。パッケージ間の型依存関係を最適化してビルド時間を短縮 |
| package.json exports最適化 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐ | exportsフィールドによる公開API制御。利用側で最小限のコードと型のみimport可能とし、不要な依存解決を排除 |
| [内部パッケージdts生成](./generate-dts.md) | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐ | モノレポ内パッケージの型定義ファイルを事前生成。依存側での型チェック負荷を削減し、開発時の応答性を向上 |
| Barrel exports最適化 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | index.tsファイルの再エクスポートパターンを最適化。不要な型解決を削減し、tree shakingとビルド性能を向上 |
| 依存グラフ最適化 | ⭐ | ⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | 重い型処理を持つ親パッケージがリーフパッケージに与える悪影響を分析・分離。インターフェース層による依存関係の軽量化 |
| ファイル分割戦略 | ⭐⭐ | ⭐⭐ | ⭐ | ⭐⭐ | ⭐⭐ | 大きなファイルの適切な分割とモジュール境界の設計。型チェック範囲の局所化と並列処理の最適化 |
| 依存関係最適化 | ⭐ | ⭐ | ⭐ | ⭐⭐ | ⭐⭐ | 不要なimport削除、dynamic import活用、循環依存の解消。型解決パスの最適化と依存グラフの簡素化 |


### 4. ビルド・ツール最適化
| 手法 | 実装容易度 | 段階実装 | AI自動化 | 性能影響 | デグレリスク | 説明 |
|------|------------|----------|----------|----------|-------------|------|
| インクリメンタルビルド | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐ | tsbuildinfo活用で変更されたファイルのみを再コンパイル。初回ビルド後の大幅な時間短縮とキャッシュ効果を実現 |
| SWC/esbuild統合 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐⭐ | Rust/Go製の高速トランスパイラー統合。TypeScriptの型チェックを保持しつつ、変換処理を10-100倍高速化 |
| 並列型チェック | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐ | fork-ts-checker-webpack-plugin等による型チェックの別プロセス化。バンドル処理と型チェックを並列実行 |
| Watch mode最適化 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐ | ファイル監視とHot Reloadの最適化。excludeパターンとpollInterval調整による開発時レスポンス改善 |
| キャッシュ戦略 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐ | Turborepo/Nxのリモートキャッシュ活用。チーム間でのビルド成果物共有とCI/CD高速化 |
| 型チェック分離 | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐⭐ | ⭐ | transpileOnlyによる型チェックと変換の分離。開発時の高速フィードバックと本格チェックの使い分け |

### 5. 性能分析・診断
| 手法 | 実装容易度 | 段階実装 | AI自動化 | 性能影響 | デグレリスク | 説明 |
|------|------------|----------|----------|----------|-------------|------|
| --generateTrace分析 | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ | ⭐ | tsc --generateTraceによる詳細な性能分析。トレースファイル生成でコンパイル処理の具体的なボトルネックを特定 |
| Chrome Tracing活用 | ⭐⭐ | ⭐⭐⭐ | ⭐ | ⭐⭐ | ⭐ | chrome://tracingでの視覚的性能分析。generateTraceの出力を詳細に解析し、時間とメモリ使用量を可視化 |
| @typescript/analyze-trace | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ | ⭐ | TypeScript公式の自動トレース解析ツール。コマンドライン実行で性能ボトルネックの自動特定と改善提案 |

### AI実装時の注意事項

- **isolatedDeclarations採用時**: TypeScript 5.5+ 要求、明示的型注釈の大量追加が必要
- **Project References**: Turborepoでの非推奨状況を考慮、他手法を優先検討  
- **型展開防止**: 劇的改善可能だが、手動での型定義見直しが必要
- **測定必須**: 全ての変更で事前事後の性能測定とts-benchでの検証実施
